var GformShortcodeUI;!function(u){var r=window.gform_admin_i18n,n=window.GformShortcodeUI={models:{},collections:{},views:{},utils:{},strings:{}};n.models.ShortcodeAttribute=Backbone.Model.extend({defaults:{attr:"",label:"",type:"",section:"",description:"",default:"",value:""}}),n.models.ShortcodeAttributes=Backbone.Collection.extend({model:n.models.ShortcodeAttribute,clone:function(){return new this.constructor(_.map(this.models,function(e){return e.clone()}))}}),n.models.Shortcode=Backbone.Model.extend({defaults:{label:"",shortcode_tag:"",action_tag:"",attrs:n.models.ShortcodeAttributes},set:function(e,t){return void 0===e.attrs||e.attrs instanceof n.models.ShortcodeAttributes||(_.each(e.attrs,function(e){null!=e.default&&(e.value=e.default)}),e.attrs=new n.models.ShortcodeAttributes(e.attrs)),Backbone.Model.prototype.set.call(this,e,t)},toJSON:function(e){return void 0!==(e=Backbone.Model.prototype.toJSON.call(this,e)).attrs&&e.attrs instanceof n.models.ShortcodeAttributes&&(e.attrs=e.attrs.toJSON()),e},clone:function(){var e=Backbone.Model.prototype.clone.call(this);return e.set("attrs",e.get("attrs").clone()),e},formatShortcode:function(){var e,n,i=[];return this.get("attrs").each(function(e){var t=e.get("value"),o=e.get("type"),r=e.get("default");(!t||t.length<1)&&"checkbox"!=o||"checkbox"==o&&"true"!=r&&!t||("content"===e.get("attr")?n=e.get("value"):i.push(e.get("attr")+'="'+t+'"'))}),e="[{{ shortcode }} {{ attributes }}]",n&&0<n.length&&(e+="{{ content }}[/{{ shortcode }}]"),e=(e=(e=e.replace(/{{ shortcode }}/g,this.get("shortcode_tag"))).replace(/{{ attributes }}/g,i.join(" "))).replace(/{{ content }}/g,n)},validate:function(e){var t=[];return e.attrs.findWhere({attr:"id"}).get("value")||t.push({id:n.strings.pleaseSelectAForm}),t.length?t:null}}),n.collections.Shortcodes=Backbone.Collection.extend({model:n.models.Shortcode}),n.views.editShortcodeForm=wp.Backbone.View.extend({el:"#gform-shortcode-ui-container",template:wp.template("gf-shortcode-default-edit-form"),hasAdvancedValue:!1,events:{"click #gform-update-shortcode":"insertShortcode","click #gform-insert-shortcode":"insertShortcode","click #gform-cancel-shortcode":"cancelShortcode"},initialize:function(){_.bindAll(this,"beforeRender","render","afterRender");var t=this;this.render=_.wrap(this.render,function(e){return t.beforeRender(),e(),t.afterRender(),t}),this.model.get("attrs").each(function(e){switch(e.get("section")){case"required":t.views.add(".gf-edit-shortcode-form-required-attrs",new n.views.editAttributeField({model:e,parent:t}));break;case"standard":t.views.add(".gf-edit-shortcode-form-standard-attrs",new n.views.editAttributeField({model:e,parent:t}));break;default:t.views.add(".gf-edit-shortcode-form-advanced-attrs",new n.views.editAttributeField({model:e,parent:t})),t.hasAdvancedVal||(t.hasAdvancedVal=""!==e.get("value"))}}),this.listenTo(this.model,"change",this.render)},beforeRender:function(){},afterRender:function(){gform_initialize_tooltips(),u("#gform-insert-shortcode").toggle("insert"==this.options.viewMode),u("#gform-update-shortcode").toggle("insert"!=this.options.viewMode),u("#gf-edit-shortcode-form-advanced-attrs").toggle(this.hasAdvancedVal)},insertShortcode:function(e){this.model.isValid({validate:!0})?(send_to_editor(this.model.formatShortcode()),tb_remove(),this.dispose()):_.each(this.model.validationError,function(e){_.each(e,function(e,t){alert(e)})})},cancelShortcode:function(e){tb_remove(),this.dispose()},dispose:function(){this.remove(),u("#gform-shortcode-ui-wrap").append('<div id="gform-shortcode-ui-container"></div>')}}),n.views.editAttributeField=Backbone.View.extend({tagName:"div",initialize:function(e){this.parent=e.parent},events:{'keyup  input[type="text"]':"updateValue","keyup  textarea":"updateValue","change select":"updateValue","change #gf-shortcode-attr-action":"updateAction","change input[type=checkbox]":"updateCheckbox","change input[type=radio]":"updateValue","change input[type=email]":"updateValue","change input[type=number]":"updateValue","change input[type=date]":"updateValue","change input[type=url]":"updateValue"},render:function(){return this.template=wp.media.template("gf-shortcode-ui-field-"+this.model.get("type")),this.$el.html(this.template(this.model.toJSON()))},updateValue:function(e){e=u(e.target);this.model.set("value",e.val())},updateCheckbox:function(e){e=u(e.target).prop("checked");this.model.set("value",e)},updateAction:function(e){var t=u(e.target).val();this.model.set("value",t);var e=this.parent.model,t=n.shortcodes.findWhere({shortcode_tag:"gravityform",action_tag:t}),r=e.get("attrs");t.get("attrs").each(function(e){var t=e.get("attr"),o=r.findWhere({attr:t});void 0!==o&&t==o.get("attr")&&(o=o.get("value"),e.set("value",String(o)))}),u(this.parent.el).empty();e=this.parent.options.viewMode;this.parent.dispose(),this.parent.model.set(t),(GformShortcodeUI=new n.views.editShortcodeForm({model:t,viewMode:e})).render()}}),n.utils.shortcodeViewConstructor={initialize:function(e){this.shortcodeModel=this.getShortcodeModel(this.shortcode)},getShortcodeModel:function(t){var e=void 0!==t.attrs.named.action?t.attrs.named.action:"",e=n.shortcodes.findWhere({action_tag:e});if(e){e=e.clone();return e.get("attrs").each(function(e){e.get("attr")in t.attrs.named&&e.set("value",t.attrs.named[e.get("attr")]),"content"===e.get("attr")&&"content"in t&&e.set("value",t.content)}),e}},getContent:function(){return this.content||this.fetch(),this.content},fetch:function(){var e,t=this;this.fetching||(this.fetching=!0,e=this.shortcodeModel.get("attrs").findWhere({attr:"id"}).get("value"),e={action:"gf_do_shortcode",post_id:u("#post_ID").val(),form_id:e,shortcode:this.shortcodeModel.formatShortcode(),nonce:gfShortcodeUIData.previewNonce},u.post(ajaxurl,e).done(function(e){t.content=e}).fail(function(){t.content='<span class="gf_shortcode_ui_error">'+gfShortcodeUIData.strings.errorLoadingPreview+"</span>"}).always(function(){delete t.fetching,t.render()}))},setLoader:function(){this.setContent('<div class="loading-placeholder"><div class="dashicons dashicons-feedback"></div><div class="wpview-loading"><ins></ins></div></div>')},View:{overlay:!0,shortcodeHTML:!1,setContent:function(n,i){this.getNodes(function(e,t,o){var r="wrap"===i||"replace"===i?t:o,o=n;_.isString(o)&&(o=e.dom.createFragment(o)),"replace"===i?e.dom.replace(o,r):"remove"===i?(t.parentNode.insertBefore(o,t.nextSibling),u(t).remove()):(r.innerHTML="",r.appendChild(o))})},initialize:function(t){var e=void 0!==t.shortcode.attrs.named.action?t.shortcode.attrs.named.action:"",e=n.shortcodes.findWhere({action_tag:e});if(!e)return this.shortcodeHTML=decodeURIComponent(t.encodedText),void(this.shortcode=!1);e=e.clone();e.get("attrs").each(function(e){e.get("attr")in t.shortcode.attrs.named&&e.set("value",t.shortcode.attrs.named[e.get("attr")]),"content"===e.get("attr")&&"content"in t.shortcode&&e.set("value",t.shortcode.content)}),this.shortcode=e},loadingPlaceholder:function(){return'<div class="loading-placeholder"><div class="dashicons dashicons-feedback"></div><div class="wpview-loading"><ins></ins></div></div>'},getEditors:function(t){var o=[];return _.each(tinymce.editors,function(e){e.plugins.wpview&&(t&&t(e),o.push(e))},this),o},getNodes:function(r){var n=[],e=this;return this.getEditors(function(o){u(o.getBody()).find('[data-wpview-text="'+e.encodedText+'"]').each(function(e,t){r&&r(o,t,u(t).find(".wpview-content").get(0)),n.push(t)})}),n},setIframes:function(h){var l=window.MutationObserver||window.WebKitMutationObserver||window.MozMutationObserver;if(-1===h.indexOf("<script"))return this.shortcodeHTML=h,void this.render();this.getNodes(function(e,t,o){var r,n,i,d,a=e.dom,s="",c=e.getBody().className||"";o.innerHTML="";wp.mce.views.sandboxStyles?s=wp.mce.views.sandboxStyles:(tinymce.each(a.$('link[rel="stylesheet"]',e.getDoc().head),function(e){e.href&&-1===e.href.indexOf("skins/lightgray/content.min.css")&&-1===e.href.indexOf("skins/wordpress/wp-content.css")&&(s+=a.getOuterHTML(e)+"\n")}),wp.mce.views.sandboxStyles=s),setTimeout(function(){if(r=a.add(o,"iframe",{src:tinymce.Env.ie?'javascript:""':"",frameBorder:"0",id:"gf-shortcode-preview-"+(new Date).getTime(),allowTransparency:"true",scrolling:"no",class:"wpview-sandbox",style:{width:"100%",display:"block"}}),(n=r.contentWindow.document).open(),n.write('<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />'+s+'<style>html {background: transparent;padding: 0;margin: 0;}body#wpview-iframe-sandbox {background: transparent;padding: 1px 0 !important;margin: -1px 0 0 !important;}body#wpview-iframe-sandbox:before,body#wpview-iframe-sandbox:after {display: none;content: "";}</style></head><body id="wpview-iframe-sandbox" class="'+c+'">'+h+"</body></html>"),n.close(),d=function(){r.contentWindow&&u(r).height(u(n.body).height())},l)new l(_.debounce(function(){d()},100)).observe(n.body,{attributes:!0,childList:!0,subtree:!0});else for(i=1;i<6;i++)setTimeout(d,700*i);d(),e.on("wp-body-class-change",function(){n.body.className=e.getBody().className})},50)})},getHtml:function(){var e;if(this.shortcode)return!1===this.shortcodeHTML&&(e=this.shortcode.get("attrs").findWhere({attr:"id"}).get("value"),e={action:"gf_do_shortcode",post_id:u("#post_ID").val(),form_id:e,shortcode:this.shortcode.formatShortcode(),nonce:gfShortcodeUIData.previewNonce},u.post(ajaxurl,e,u.proxy(this.setIframes,this))),this.shortcodeHTML;this.setContent(this.shortcodeHTML,"remove")}},edit:function(e){var o,t;"object"==typeof e&&(e=decodeURIComponent(jQuery(e).attr("data-wpview-text"))),(t=wp.shortcode.next("gravityform",e))&&(e=t.shortcode.attrs.named.action||"",(e=n.shortcodes.findWhere({shortcode_tag:t.shortcode.tag,action_tag:e}))&&(o=e.clone(),_.each(t.shortcode.attrs.named,function(e,t){attr=o.get("attrs").findWhere({attr:t}),attr&&attr.set("value",e)}),t=o.get("attrs").findWhere({attr:"id"}).get("value"),u("#add_form_id").val(t),(GformShortcodeUI=new n.views.editShortcodeForm({model:o,viewMode:"update"})).render(),u("#gform-insert-shortcode").hide(),u("#gform-update-shortcode").show(),tb_show(r.shortcodeUi.editForm,"#TB_inline?inlineId=select_gravity_form&width=753&height=686","")))}},u(document).ready(function(){n.strings=gfShortcodeUIData.strings,n.shortcodes=new n.collections.Shortcodes(gfShortcodeUIData.shortcodes),gfShortcodeUIData.previewDisabled||void 0===wp.mce||wp.mce.views.register("gravityform",u.extend(!0,{},n.utils.shortcodeViewConstructor)),u(document).on("click",".gform_media_link",function(){n.shortcodes=new n.collections.Shortcodes(gfShortcodeUIData.shortcodes);var e=n.shortcodes.findWhere({shortcode_tag:"gravityform",action_tag:""});(GformShortcodeUI=new n.views.editShortcodeForm({model:e,viewMode:"insert"})).render(),tb_show(r.shortcodeUi.insertForm,"#TB_inline?inlineId=select_gravity_form&width=753&height=686","")})})}((window.gfShortcodeUI=window.gfShortcodeUI||{},jQuery));